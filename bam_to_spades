#!/bin/bash
set -euo pipefail

THREADS=8
MEM=32

# Directories
BAM_DIR="mapped_sam"
FASTQ_DIR="mt_fastq"
SPADES_DIR="spades_mt_pooled"

POOLED_R1="pooled_mt_R1.fastq"
POOLED_R2="pooled_mt_R2.fastq"

mkdir -p "$FASTQ_DIR" "$SPADES_DIR"

echo "Step 1: BAM → mitochondrial FASTQ"

# Convert BAM → FASTQ (mt reads)
for bam in ${BAM_DIR}/*.mt.sorted.bam; do
    base=$(basename "$bam" .mt.sorted.bam)

    echo "Extracting mt reads for $base"

    samtools fastq "$bam" \
        -1 "${FASTQ_DIR}/${base}_R1.fastq" \
        -2 "${FASTQ_DIR}/${base}_R2.fastq" \
        -0 /dev/null \
        -s /dev/null \
        -n
done

echo "Step 2: Pool mitochondrial FASTQs"

# Pool FASTQs
cat ${FASTQ_DIR}/*_R1.fastq > "$POOLED_R1"
cat ${FASTQ_DIR}/*_R2.fastq > "$POOLED_R2"

echo "Pooled FASTQs created:"
echo "  $POOLED_R1"
echo "  $POOLED_R2"

echo "Step 3: Run SPAdes (mtDNA-safe)"

# Run SPAdes

rm -rf "$SPADES_DIR"

spades.py \
    -1 pooled_mt_R1.fastq \
    -2 pooled_mt_R2.fastq \
    --only-assembler \
    --cov-cutoff=off \
    -k 21,33,55,77 \
    -t 8 \
    -m 32 \
    -o spades_mt_pooled

echo "Pipeline completed successfully"


